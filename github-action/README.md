# Diachron PR Narrative GitHub Action

Post AI provenance evidence to pull requests automatically.

## Overview

This GitHub Action reads a Diachron evidence pack and posts a formatted comment to your PR showing:
- **Intent**: What the AI was asked to do
- **What Changed**: Files modified, lines added/removed, tool operations
- **Evidence Trail**: Events linked to commits with confidence levels
- **Verification**: Hash chain integrity, tests, build status

## Usage

```yaml
- uses: wolfiesch/diachron/github-action@main
  with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    evidence-path: 'diachron.evidence.json'  # optional
    comment-mode: 'update'  # or 'new'
    fail-on-missing: 'false'
```

## Inputs

| Input | Description | Default |
|-------|-------------|---------|
| `github-token` | GitHub token for PR comments (required) | - |
| `evidence-path` | Path to evidence JSON file | `diachron.evidence.json` |
| `comment-mode` | `update` existing or create `new` | `update` |
| `fail-on-missing` | Fail if evidence file missing | `false` |

## Outputs

| Output | Description |
|--------|-------------|
| `comment-id` | ID of the created/updated comment |
| `coverage` | Event-to-commit coverage percentage |
| `verified` | Whether hash chain is verified |

## Generating Evidence

### Option 1: Local generation (recommended)

Before pushing your PR branch:

```bash
# Generate evidence pack
diachron export-evidence --output diachron.evidence.json

# Commit with your changes
git add diachron.evidence.json
git commit -m "feat: add auth flow with provenance"
git push
```

### Option 2: CI generation

Add to your workflow:

```yaml
- name: Install Diachron CLI
  run: cargo install diachron

- name: Generate evidence
  run: |
    diachron export-evidence \
      --pr ${{ github.event.pull_request.number }} \
      --branch ${{ github.head_ref }} \
      --output diachron.evidence.json
```

## Example PR Comment

```markdown
## PR #142: AI Provenance Evidence

### Intent
> Fix the 401 errors on page refresh

### What Changed
- **Files modified**: 2
- **Lines**: +45 / -10
- **Tool operations**: 3
- **Sessions**: 1

### Evidence Trail
- **Coverage**: 100.0% of events matched to commits

**Commit `abc1234`**: Fix OAuth2 refresh (HIGH)
  - `Write` create → src/auth.rs
  - `Edit` modify → src/auth.rs

### Verification
- [x] Hash chain integrity
- [x] Tests executed after changes
- [x] Build succeeded
- [ ] Human review

---
*Generated by Diachron v0.3.0 at 2026-01-11T00:00:00Z*
```

## Development

```bash
# Install dependencies
npm install

# Build action
npm run build

# The dist/ folder is what gets executed
```

## License

MIT
